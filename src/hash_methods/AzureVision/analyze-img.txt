#!/usr/bin/bash
# key_1
key="$(cat ./resource_key.txt)"
endpoint="https://analyze-image-foxik.cognitiveservices.azure.com/"

# Code to call Computer Vision service for image analysis
# HH make it so output can be processed

# HH maybe the whole path is given? yup it should be
img_remote_directory="https://github.com/gyarab/2023-4e-liska-near_duplicate_img_detection/blob/main/data/imgs"
img_file="resurrected.jpg"
if [ $# -gt 1 ]; then
    img_file=$1
	img_remote_directory=$(echo $2 | sed "s/\(github.com\/[^/]*\/[^/]*\/\)/\1blob\//g")
fi



#if ! [ $2 =~ '^[0-9]+$' ]; then
#	$2=0
#fi	

# HH replace with your server
img="$img_remote_directory/$img_file?raw=true"
headers=()
headers+=("Ocp-Apim-Subscription-Key: $key")
headers+=("Content-Type: application/json")

body="{\"url\": \"$img\"}"

echo "Analyzing image..."
result=$(curl -X POST -H "${headers[0]}" -H "${headers[1]}" -d "$body" "$endpoint/vision/v3.2/analyze?visualFeatures=Categories,Description,Objects")

: <<'DEBUG'
# Debug statement to print the result
echo "API Result:"
echo "$result"
DEBUG
# Check if the result is not empty before processing with jq
if [ -n "$result" ]; then
    analysis=$(echo "$result" | jq -r '. | @json')
else
    echo "API call did not return a valid result."
    exit 1
fi

#exec > output.log
#output_file="./data/tmp/did_tmp$2"

echo -e "\n[[Description]]{"
echo "$analysis" | jq -r '.description.captions[].text'
echo "}"

echo -e "\n[[Objects]]{"
echo "$analysis" | jq -r '.objects[].object'
echo "}"

echo -e "\n[[Tags]]{"
echo "$analysis" | jq -r '.description.tags[]'
echo "}"

echo
